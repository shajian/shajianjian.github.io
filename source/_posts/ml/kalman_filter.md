---
title: 卡尔曼滤波
date: 2025-01-15 15:06:48
tags: machine learning
p: ml/
---

# 1. 简介

## 1.1 随机变量

__矩__

1. k 阶原点矩，是随机变量 k 次幂的期望：$E(X^k)$

2. k 阶中心矩，是随机变量与均值之差的 k 次幂的期望：$E((X-\mu_X)^k)$

## 1.2 估计、准度和精度

估计 Estimation 是对系统的隐藏状态的估计。

准度 Accuracy 描述测量值与真值的接近情况。

精度 Precision 描述一系列测量值相对同一个真值的偏差分布情况。

高精度系统的测量值具有 __很低__ 的方差（不确定性），随机测量噪声造成了这些不确定性。

低准度系统又称为 __有偏Biased__ 系统，这是由系统误差（偏差）造成。

# 2. 静态系统

静态系统：系统状态不随时间变化，例如一座塔的高度，或者一根金条的重量。

本例中，我们估计一根金条的重量，假定称金条的秤是无偏的，即没有 __系统偏差__（高准度），但是有 __随机噪声__（测量噪声，低精度）。

金条的重量就是我们关心的系统状态。我们多次称重，取平均值，

$$\hat x_{n,n} = \frac 1 n \sum _ {i=1}^n z_i$$

其中：

1. $x$ 是金条重量的真值
2. $z_n$ 是 n 时刻金条的测量值（称重值）
3. $\hat x _ {n, n}$ 是 n 时刻的估计值（即，n 次测量之后的估计值）
4. $\hat x _ {n+1, n}$ 是在 n 时刻为未来状态（n+1时刻）的预测，或者说外插
5. $\hat x _ {n,n-1}$ 是一个先验估计，在 n-1 时刻对 n 时刻的系统状态的预测。（对第 n 个时刻而言，$\hat x _ {n,n-1}$ 是先验估计，$\hat x _ {n+1,n}$ 是预测）

静态系统中，有

$$\hat x _ {n+1,n} = \hat x _ {n,n}$$

如果存储所有时刻的测量值，然后计算平均值，那么内存开销较大，并且每次测量后，都要重新计算，CPU 消耗也大。

考虑存储上一时刻的估计值 $\hat x _ {n-1,n-1}$，然后在本次测量后更新状态估计值，步骤为：

1. 根据当前的测量 $z_n$ 和先验估计 $\hat x _ {n,n-1}$，估计当前的状态 $\hat x _ {n,n}$
2. 根据当前的状态估计 $\hat x _ {n,n}$ 和系统模型，进行下一时刻的预测 $\hat x _ {n+1,n}$

根据移动平均的思想，递归公式如下，

$$\hat x _ {n,n} = \hat x _ {n-1,n-1} + \frac 1 n (z _ n - \hat x _ {n-1,n-1})$$

由于静态系统中有 $\hat x _ {n,n-1} = \hat x _ {n-1,n-1}$，那么对于一般的系统，递归公式为

$$\hat x _ {n,n}=\hat x _ {n,n-1} + \frac 1 n (z _ n - \hat x _ {n, n-1}) \tag{1}$$

(1) 式就是卡尔曼滤波的五个方程之一，称为 __状态更新方程__，表示

```sh
+----------+   +---------------+   +---+    +--                   --+
|当前状态估计| = |当前状态的先验预估| + |因子| x | 测量值 - 当前状态的先验预估|
+----------+   +---------------+   +---+    +--                   --+
```

$(z_n - \hat x _ {n,n-1})$ 称为测量残差，也叫更新量。

本例中，随机 n 增加，$1/n$ 下降，一开始，因为没有足够的信息，第一次估计完全基于第一次的测量值，随机迭代进行，后续测量的权重下降，最后使得更新量忽略不计。

# 3. 动态系统

__跟踪直线匀速运动的飞行器__

假设一个一维世界中，一个飞行器往远离雷达的方向飞行，由于是一维空间，飞行器与雷达的角度恒定，高度也恒定。本例中，系统状态为飞行器的距离。

令 $x_n$ 表示 n 时刻飞行器的距离，速度是距离的导数，

$$v=\dot x = \frac {dx}{dt}$$

雷达向目标方向以固定频率发射跟踪波束，两次跟踪测量之间的时间间隔为 $\Delta t$，__匀速__ 运动的动力学模型由下面方程给出：

$$x_{n+1,n} = x_{n,n} + \Delta t \dot x _ {n,n}
\\\\ \dot x _ {n+1,n}=\dot x _ {n,n}$$

上述方程称为状态外插方程（或称 转移方程、预测方程）。

上个静态系统的例子中已经用过状态外插方程了，只是静态系统中这个方程是个恒等式（状态不变），即下一时刻的状态等于当前时刻的状态。

注：两个卡尔曼滤波方程 __状态更新方程__，__状态外插方程__

## 3.1 alpha-beta 滤波器

假设雷达的跟踪间隔为 $\Delta=5$ 秒，n-1 时刻飞行器的距离为 30000 m，速度为 40 m/s。使用上述状态外插方程，可以预测 n 时刻的目标位置为

$$\hat x _ {n, n-1}=\hat x _ {n-1,n-1}+ \Delta t \hat {\dot x} _ {n-1,n-1}=30000+5\times 40=30200$$

预测目标 n 时刻的速度为

$$\hat {\dot x} _ {n,n-1}=\hat {\dot x} _{n-1,n-1}=40$$

然而 n 时刻雷达测量的目标距离 ( $z_n$ ) 为 30110m 而非 30200m。预测和实际测量的距离之间相差了90m. 这个差有可能是两个原因导致的：

1. 雷达测量不够精准
2. 飞行器速度变化了。新的速度是 $30110−30000/5=22$

哪个原因是正确的呢？

我们把速度的状态更新方程写下来：

$$\hat {\dot x} _ {n,n} = \hat {\dot x} _ {n,n-1} + \beta  \left( \frac {z_n - \hat {\dot x} _ {n,n-1}}{\Delta t}\right) \tag{2}$$

即，当前时刻的速度估计等于当前时刻的速度预估（先验）与速度残差之和，其中速度残差带有一个权重因子。

系数 $\beta$ 与雷达的测量精度有关。

假设1：雷达的 $1\sigma$（测量噪声标准差）是 20m，那么 90m 的误差大概是 __飞行器速度改变__ 了，那么我们就应该对测量值更加侧重，即 $\beta$ 取较大的一个值，如 $\beta=0.9$，那么根据 (2) 式，估计速度为

$$\hat {\dot x} _ {n,n}=40+0.9\left(\frac {30110-30200} 5 \right)=23.8$$

假设2：雷达的 $1\sigma$ 精度是 150m，那么 90m 的误差大概率是 __雷达测得不准__，那么与测量相关的权重因子 $\beta$ 应该小一点，如 $\beta=0.1$，那么速度估计为

$$\hat {\dot x} _ {n,n}=40+0.1\left(\frac {30110-30200} 5 \right)=38.2$$

飞行器的位置状态更新方程如下：

$$\hat x _ {n,n}=\hat x _ {n,n-1} + \alpha (z_n - \hat x _ {n,n-1})\tag{3}$$

上例静态系统中 $\alpha=1/n$ 每次更新都要重新计算，而本例中 $\alpha$ 恒定。

$\alpha$ 取值与雷达精度有关，高精度雷达则 $\alpha$ 应该取较大的值。极端情况：

1. $\alpha=1$，则估计的飞行器距离等于测量值
2. $\alpha=0$，则测量值不起任何作用

__跟踪直线加速运行的飞行器__

考虑一架战斗机，先以 50m/s 匀速飞行 20s，然后以 $8m/s^2$ 匀加速 35s。

下图描述了目标距离、速度和加速度与时间的关系。

![](/images/ml/kalman_filter1.jpg)

我们先用前面的 $\alpha-\beta$ 滤波器跟踪这架飞行器，参数设置为

- $\alpha=0.2$
- $\beta=0.1$
- $\Delta t=5$

初始条件为 $\hat x _ {0,0}=30000m, \ \hat {\dot x} _ {0,0}=50m/s$

迭代过程如下，

![](/images/ml/kalman_filter2.jpg)

结果如下图所示，

![](/images/ml/kalman_filter3.jpg)

可以看到在真值和估计值之间有一个稳态误差。这个稳态误差又叫 滞后误差，也叫：

- 动态误差
- 系统误差
- 偏差
- 截断误差

滞后误差在加速阶段开始出现。在加速阶段结束后，滤波器会追上这个误差并收敛到真值。然而，如此大的滞后误差可能直接导致目标跟丢，这是一些应用场景里是无法接受的，例如导弹制导或防空。

## 3.2 alpha-beta-gamma 滤波器

略

# 4. 一维卡尔曼滤波

卡尔曼滤波基于 5 个方程，上面已经介绍了其中两个：

1. 状态更新方程
2. 动态模型方程

本节我们推导其余三个方程，类似 $\alpha-\beta-(\gamma)$ 滤波器，卡尔曼滤波也使用“测量、更新、预测”三个步骤，不同的是，
卡尔曼滤波将测量值、当前状态估计和下一状态预测均视为具有正态分布的随机变量，这些随机变量由均值和方差描述。

__估计误差__：估计值和真值之间的差。
 
随着测量次数的增加，估计误差不断下降，并最终收敛到0，同时估计值收敛到真值。实际中我们无法知道估计误差，但是我们可以计算 __估计值的不确定性__。

记状态估计值的方差为 $p$。

__测量误差__：测量值和真值之间的差。

测量误差是随机的，可以使用方差 $\sigma^2$ 描述，对应的标准差 $\sigma$ 就是 __测量不确定性__。

卡尔曼滤波将状态视为一个随机变量，除了将状态估计外插，还需要将状态的方差也外插。

当前状态估计：$\hat x _ {n,n}, p _ {n,n}$
外插到下一个状态：$\hat x _ {n+1,n}, p _ {n+1,n}$

在上面第一个示例（金条称重）中，系统模型为静态，故状态（即金条重量）估计的不确定性（方差）恒定，

$$\hat p _ {n+1,n}=\hat p _ {n,n}$$

在第二个示例里，状态的不确定性按如下外插，

$$p _ {n+1,n}^x = p _ {n,n}^x + \Delta t^2 \cdot p _ {n,n}^v
\\\\ p _ {n+1,n} ^v = p _ {n,n} ^ v$$

这里，由于模型假设速度恒定不变，故速度的方差不变。对 $x_{n+1,n} = x_{n,n} + \Delta t \dot x _ {n,n}$ 两边取方差，得到上面距离的方差外插公式。

上述状态估计的外插方差是第三个卡尔曼滤波方程。

## 4.1 状态更新方程

我们使用了两个随机变量来估计系统当前的状态：

- 状态预测
- 测量值

卡尔曼滤波器是一种 __最优滤波器__，最优性体现在它能够把上述状态预测和测量值融合在一起，使得得到的当前状态估计不确定性最小。

当前状态估计值是状态预测和测量值的加权和：

$$\hat x _ {n,n}=w_1 z_n + w_2 \hat x _ {n,n-1}
\\\\ w_1 + w_2=1$$

其中 $w_1, w_2$ 表示权重。

变换上式为

$$\hat x _ {n,n}=w_1 z_n + (1-w_1) \hat x _ {n,n-1}$$

两边取方差得

$$p _ {n,n} = w _ 1 ^ 2 r_n + (1-w_1)^2 p _ {n,n-1}$$

其中 $r_n$ 是测量值 $z_n$ 的方差。

我们试图找到一个 __最优__ 估计使其能最小化 $p_{n,n}$。为此，求导如下，

$$\frac {d p _ {n,n}} {d w _ 1}=2w_1 r_n - 2 (1-w_1) p _ {n,n-1}=0$$

求解得

$$w_1 = \frac {p_{n,n-1}} {p _ {n,n-1} + r_n}$$

将上述 $w_1$ 的解代入状态外插方程得

$$\hat x _ {n,n}=\hat x _ {n,n-1}+w_1(z_n - \hat x _ {n,n-1})$$

$$\hat x _ {n,n}=\hat x _ {n,n-1}+\frac {p_{n,n-1}} {p _ {n,n-1} + r_n}(z_n - \hat x _ {n,n-1})\tag{4}$$

其中更新量对应得权重称为卡尔曼增益 $K_n$。

卡尔曼增益方程是第四个滤波方程，一维情况下，卡尔曼增益方程为

$$K_n=\frac {预测值方差}{预测值方差+测量值方差}=\frac {p_{n,n-1}} {p _ {n,n-1} + r_n}\tag{5}$$

注意：预测值不是估计值，预测值其实是上一状态的估计值对下一状态的外插，即预测。

$K_n \in [0,1]$

对状态估计方差两边取方差，得到状态不确定性的估计为

$$p_{n,n}=w_1^2 r_n + (1-w_1)^2 p _ {n,n-1}$$

权重 $w_1$ 就是卡尔曼增益 $K_n$（随时间变化），

$$p_{n,n}=K_n^2 r_n + (1-K_n)^2 p _ {n,n-1}$$

简化上式可得

$$p_{n,n}=(1-K_n)p_{n,n-1} \tag{6}$$

上式称为 __协方差更新方程__。

根据 (6) 式，由于 $(1-K_n) \in [0,1]$，所以状态估计的不确定性一直下降。

当测量不确定性很高时，$K_n$ 很小，状态估计不确定性收敛较慢。

__# 小结__

滤波器输入

1. 初始化

    - 初始状态 $\hat x _ {0,0}$
    - 初始状态方差 $p _ {0,0}$

2. 测量

    - 测量值 $z_n$
    - 测量方差 $r_n$

滤波器输出

1. 状态估计 $\hat x _ {n,n}$
2. 状态估计方差 $p _ {n,n}$

卡尔曼滤波方程如下图，

![](/images/ml/kalman_filter4.jpg)

迭代过程为

1. 第0步：初始化

    初始化仅执行一次，提供两个参数：

    - 初始状态 ($\hat x _ {0,0}$)
    - 初始状态方差 ($p_{0,0}$)

2. 第1步：测量
    测量过程也提供两个参数：

    - 测量值 ($z_n$)
    - 测量方差 ($r_n$)

3. 第2步：状态更新

    状态更新过程给出当前系统状态的估计。

    状态更新过程的输入为：

    - 测量值 ($z_n$)
    - 测量方差 ($r_n$)
    - 状态预测 ($ \hat x_{n,n−1}$)（根据模型确定）
    - 状态预测方差 ($p_{n,n−1}$)（根据模型确定）

    基于这些输入，状态更新过程计算卡尔曼增益并产生输出：

    - 状态估计 ($\hat x_{n,n}$)
    - 状态估计方差 ( $p_{n,n}$)

4. 第3步：预测

    预测过程使用系统动态模型将当前系统的状态估计及其方差外插到下一个时刻。

    __第一次迭代时，初始化参数被当作状态预测的值和方差。__

    预测的输出被当作下一个时刻的状态预测的值和方差。

## 4.2 卡尔曼增益理解

状态更新方程为

$$\hat x _ {n,n} = \hat x _ {n,n-1} + K_n(z_n - \hat x _ {n,n-1})=(1-K_n) \hat x _ {n,n-1} + K_n z_n$$

卡尔曼增益 $K_n$ 是测量值的权重，$1-K_n$ 是当前状态预测的权重。

__高卡尔曼增益__

测量不确定性相对预测不确定性很低，此时 $K_n \rightarrow 1$，新的估计接近预测值，下图描述了低卡尔曼增益在飞行器跟踪问题中的效果。

![](/images/ml/kalman_filter5.jpg)

__低卡尔曼增益__

测量不确定性相对预测不确定性很高的时候卡尔曼增益很低（$K_n \rightarrow 0$），新的估计接近预测值，下图描述了低卡尔曼增益在飞行器跟踪问题中的效果。

[](/images/ml/kalman_filter6.jpg)

# REF

1. https://www.kalmanfilter.net/CN/alphabeta_cn.html